<!doctype html>
<html lang="ru">

<head>
  <meta charset="utf-8">
  <title>PDF uploader</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="p-3">
  <h4>Добавление PDF-документа</h4>

  <form id="pdfUploadForm" enctype="multipart/form-data" method="post" class="mb-3">
    <div class="row g-3">
      <div class="col-md-3">
        <label class="form-label">Артикул</label>
        <input id="inpArticle" class="form-control" placeholder="например, ABC-123">
      </div>
      <div class="col-md-3">
        <label class="form-label">Бренд</label>
        <select id="selVendor" class="form-select">
          <option value="">(выбрать бренд)</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">ID товара (resource_id)</label>
        <input id="ridInput" type="number" class="form-control" placeholder="например, 123">
      </div>
      <div class="col-md-3 d-flex align-items-end">
        <button type="button" id="btnLookup" class="btn btn-outline-secondary w-100">
          Найти (по ID/артикулу)
        </button>
      </div>
    </div>

    <div class="row g-3 mt-2">
      <div class="mb-3">
        <label for="title" class="form-label">Заголовок документа</label>
        <input type="text" class="form-control" id="title" name="title" placeholder="Напр.: Руководство пользователя">
      </div>

      <div class="col-md-6">
        <label class="form-label">Файл PDF</label>
        <input type="file" name="pdf_file" id="pdf_file" accept="application/pdf" class="form-control">
      </div>
      <div class="col-md-6">
        <label class="form-label">Папка</label>
        <select id="folderSelect" name="folder" class="form-select">
          <option value="">(выбрать)</option>
        </select>
      </div>

      <div class="mb-3">
        <label for="massArticles" class="form-label">Список артикулов (через запятую или перенос строки)</label>
        <textarea id="massArticles" name="mass_articles" rows="3" class="form-control"
          placeholder="Напр.: 2020016, 2020017, 2020018"></textarea>
      </div>
      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="massMode" name="mass_mode" value="1">
        <label class="form-check-label" for="massMode">
          Массовое добавление (один файл для всех артикулов)
        </label>
      </div>

    </div>

    <div class="mt-3">
      <button type="submit" class="btn btn-primary">Загрузить</button>
      <button type="button" id="btnSearch" class="btn btn-outline-primary ms-2">Найти документы</button>
    </div>
  </form>

  <div id="searchResults" class="mt-3"></div>

  <hr class="my-4">

  <h5>Поиск по уже загруженному файлу</h5>
  <div class="row g-2 align-items-end">
    <div class="col-md-3">
      <label class="form-label">Папка</label>
      <select id="usageFolderSelect" class="form-select">
        <option value="">(выбрать)</option>
      </select>
    </div>
    <div class="col-md-5">
      <label class="form-label">Файл (PDF)</label>
      <select id="usageFileSelect" class="form-select" disabled>
        <option value="">(сначала выберите папку)</option>
      </select>
    </div>
    <div class="col-md-2">
      <button id="btnUsageSearch" type="button" class="btn btn-outline-primary w-100" disabled>
        Найти привязки
      </button>
    </div>
  </div>

  <pre id="resultBox" class="bg-light p-2 small" data-test></pre>
  <div id="usageResults" class="mt-3"></div>

  <!-- ТЕХНИЧЕСКИЕ ДЕТАЛИ (свёрнуто по умолчанию) -->
  <div class="card mt-3">
    <div class="card-header d-flex align-items-center justify-content-between">
      <span>Технические детали</span>
      <div>
        <span id="techBadge" class="badge bg-secondary me-2" style="display:none;">OK</span>
        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
          data-bs-target="#techCollapse" aria-expanded="false" aria-controls="techCollapse">
          Показать / скрыть
        </button>
      </div>
    </div>
    <div id="techCollapse" class="collapse">
      <div class="card-body">
        <div class="mb-2">
          <strong id="techTitle">Последний ответ сервера</strong>
          <small class="text-muted ms-2" id="techTimestamp"></small>
        </div>
        <pre id="techPayload" class="bg-light p-2 rounded"
          style="max-height:300px; overflow:auto; white-space:pre-wrap;"></pre>
        <div id="techDiagnosticsWrap" style="display:none;">
          <hr>
          <div class="fw-bold">Diagnostics</div>
          <pre id="techDiagnostics" class="bg-light p-2 rounded"
            style="max-height:200px; overflow:auto; white-space:pre-wrap;"></pre>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


  <script>
    const cfg = window.parent?.PDFUP_CONF || {};
    const connectorUrl = cfg.connectorUrl || '/assets/components/pdfuploader/connector.php';

    function setTechBadge(state, text) {
      const b = document.getElementById('techBadge');
      if (!b) return;
      let cls = 'bg-secondary';
      if (state === 'ok') cls = 'bg-success';
      if (state === 'warn') cls = 'bg-warning text-dark';
      if (state === 'err') cls = 'bg-danger';
      b.className = 'badge me-2 ' + cls;
      b.textContent = text || (state === 'ok' ? 'OK' : state === 'warn' ? 'WARN' : 'ERR');
      b.style.display = '';
    }

    function updateTechPanel(title, rawTextOrObj, diagnostics) {
      const t = document.getElementById('techTitle');
      const ts = document.getElementById('techTimestamp');
      const p = document.getElementById('techPayload');
      const dw = document.getElementById('techDiagnosticsWrap');
      const d = document.getElementById('techDiagnostics');
      if (!t || !ts || !p || !dw || !d) return;

      t.textContent = title || 'Последний ответ сервера';
      ts.textContent = new Date().toLocaleString();
      // payload
      let text = '';
      if (typeof rawTextOrObj === 'string') {
        text = rawTextOrObj;
        try { text = JSON.stringify(JSON.parse(rawTextOrObj), null, 2); } catch (_) { }
      } else {
        try { text = JSON.stringify(rawTextOrObj, null, 2); } catch (e) { text = String(rawTextOrObj); }
      }
      p.textContent = text;

      // diagnostics
      if (diagnostics && diagnostics.length) {
        d.textContent = Array.isArray(diagnostics) ? diagnostics.join('\n') : String(diagnostics);
        dw.style.display = '';
        setTechBadge('warn', 'WARN'); // есть diagnostics — ставим WARN
      } else {
        d.textContent = '';
        dw.style.display = 'none';
        setTechBadge('ok', 'OK');
      }
    }


    async function loadVendors() {
      const r = await fetch(connectorUrl + '?action=list_vendors', { credentials: 'same-origin' });
      const txt = await r.text(); let j;
      try { j = JSON.parse(txt); } catch (e) { console.error('list_vendors raw:', txt); throw e; }
      if (!j.success) throw new Error(j.message || 'Ошибка загрузки брендов');
      const sel = document.getElementById('selVendor');
      sel.innerHTML = '<option value="">(выбрать бренд)</option>';
      (j.vendors || []).forEach(v => {
        const opt = document.createElement('option');
        opt.value = String(v.id);
        opt.textContent = v.name;
        sel.appendChild(opt);
      });
    }

    async function loadFolders() {
      const r = await fetch(connectorUrl + '?action=list_folders', { credentials: 'same-origin' });
      const txt = await r.text(); let j;
      try { j = JSON.parse(txt); } catch (e) { console.error('list_folders raw:', txt); throw e; }
      const sel = document.getElementById('folderSelect');
      sel.innerHTML = '<option value="">(выбрать)</option>';
      if (j.success) {
        (j.folders || []).forEach(f => {
          const o = document.createElement('option'); o.value = f; o.textContent = f; sel.appendChild(o);
        });
      }
      const def = cfg.defaultFolder || '';
      if (def) {
        if (![...sel.options].some(o => o.value === def)) {
          const opt = document.createElement('option');
          opt.value = def; opt.textContent = def + ' (авто)';
          sel.insertBefore(opt, sel.firstChild);
        }
        sel.value = def;
      }
      populateUsageFolders();
    }

    // универсальный «быстрый поиск»: если указан ID — сразу ищем документы по ID,
    // иначе — ищем товар по артикулу и подставляем его ID
    document.getElementById('btnLookup').addEventListener('click', async () => {
      const ridStr = (document.getElementById('ridInput')?.value || '').trim();
      const rid = ridStr ? Number(ridStr) : 0;

      if (rid) {
        // Уже знаем resource_id — не требуем артикул, просто найдём документы
        await doSearch(); // вызовет search_all с resource_id
        return;
      }

      // fallback: поиск товара по артикулу, как раньше
      const art = (document.getElementById('inpArticle')?.value || '').trim();
      const vid = document.getElementById('selVendor')?.value || '';
      if (!art) { alert('Введите артикул или укажите ID товара'); return; }

      const q = new URLSearchParams({ action: 'lookup_product', article: art });
      if (vid) q.append('vendor_id', vid);

      const r = await fetch(connectorUrl + '?' + q.toString(), { credentials: 'same-origin' });
      const j = await r.json();
      if (!j.success) { alert(j.message || 'Ошибка поиска'); return; }
      if (!j.items?.length) { alert('Товар не найден'); return; }

      const it = j.items[0];
      document.getElementById('ridInput').value = it.resource_id;
      if (it.vendor_id) document.getElementById('selVendor').value = String(it.vendor_id);

      // и сразу покажем привязки для найденного товара
      await doSearch();
    });


    // загрузка PDF
    document.getElementById('pdfUploadForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);

      const isMass = document.getElementById('massMode').checked;
      const arts = document.getElementById('massArticles').value.trim();

      if (isMass && arts) {
        fd.append('action', 'upload_pdf_mass');
        fd.append('mass_articles', arts);
      } else {
        fd.append('action', 'upload_pdf');
        fd.append('article', document.getElementById('inpArticle').value.trim());
      }

      fd.append('vendor_id', document.getElementById('selVendor').value || '0');
      fd.append('resource_id', document.getElementById('ridInput').value || (cfg.rid || ''));
      // передаём видимое имя бренда (сервер при этом сам подтягивает по id)
      const sel = document.getElementById('selVendor');
      const vname = sel.options[sel.selectedIndex]?.text || '';
      fd.append('vendor_name', vname);

      const res = await fetch(connectorUrl, { method: 'POST', body: fd, credentials: 'same-origin' });
      const txt = await res.text(); let j;
      try { j = JSON.parse(txt); } catch (e) { console.error('upload raw:', txt); throw e; }
      updateTechPanel(isMass ? 'upload_pdf_mass' : 'upload_pdf', j, j.diagnostics || []);
      // document.getElementById('resultBox').textContent = JSON.stringify(j, null, 2);

      if (isMass && j.success) {
        // показать отчёт, если пришёл
        if (j.report) {
          const rpt = j.report;
          const wrap = document.getElementById('searchResults');
          const list = (label, arr) =>
            arr && arr.length ? `<div><strong>${label} (${arr.length}):</strong> ${arr.map(x => typeof x === 'string' ? x : x.article).join(', ')}</div>` : '';
          wrap.innerHTML = `
            <div class="alert alert-info">
              <div><strong>Итого:</strong> всего ${rpt.total_input}, добавлено ${rpt.total_added}, пропущено ${rpt.total_skipped}, дубликаты ${rpt.total_duplicates}</div>
              ${list('Добавлены', rpt.added)}
              ${list('Не найдены', rpt.skipped)}
              ${list('Уже были', rpt.duplicates)}
            </div>`;
        }
        // ⬇ ПУНКТ 3 — сбрасываем массовый режим после успешной массовой загрузки
        const cb = document.getElementById('massMode');
        const ta = document.getElementById('massArticles');
        if (cb) cb.checked = false;
        if (ta) ta.value = '';
      } else if (j.success) {
        // одиночный режим — обновим список по артикулу
        doSearch();
      }
    });

    // универсальный поиск (используется кнопкой и после удаления)
    async function doSearch(articleOpt) {
      const mass = !!document.getElementById('massMode')?.checked;

      // 1) resource_id из поля
      const ridStr = (document.getElementById('ridInput')?.value || '').trim();
      const rid = ridStr ? Number(ridStr) : 0;

      // 2) артикул — из параметра (если передали строку), иначе из поля
      const art = (typeof articleOpt === 'string' && articleOpt.trim().length)
        ? articleOpt.trim()
        : (document.getElementById('inpArticle')?.value || '').trim();

      // 3) в одиночном режиме нужен хотя бы RID или артикул
      if (!mass && !rid && !art) {
        alert('Введите resource_id или артикул');
        return;
      }
      // в массовом режиме — артикул опционален; если пусто и rid пуст — просто подсказка
      if (mass && !rid && !art) {
        document.getElementById('searchResults').innerHTML =
          '<div class="text-muted">В массовом режиме укажите resource_id или артикул для поиска конкретной карточки.</div>';
        return;
      }

      const vid = document.getElementById('selVendor')?.value || '';
      const q = new URLSearchParams({ action: 'search_all', tv_name: 'sertif' });
      if (rid) q.append('resource_id', String(rid));
      if (art) q.append('article', art);
      if (vid) q.append('vendor_id', vid);

      const r = await fetch(connectorUrl + '?' + q.toString(), { credentials: 'same-origin' });
      const txt = await r.text();
      let j;
      try { j = JSON.parse(txt); } catch (e) { updateTechPanel('search_all (parse error)', txt, []); throw e; }

      updateTechPanel('search_all', j, j.diagnostics || []);

      const wrap = document.getElementById('searchResults');

      const regHtml = (j.from_registry || []).map(x => {
        const btnDel = `<button class="btn btn-sm btn-outline-danger ms-2"
                      onclick="deleteRegistry(${Number(x.id) || 0})">Удалить из реестра</button>`;
        return `<li>
      Реестр: <a href="${x.pdf_url}" target="_blank">${x.pdf_name || x.pdf_url}</a>
      ${x.preview ? `— <img src="${x.preview}" style="height:40px;vertical-align:middle">` : ''}
      <small class="text-muted">[${x.vendor_name || ''}]</small>
      ${btnDel}
    </li>`;
      }).join('');

      const migHtml = (j.from_migx || []).map(x => {
        const encFile = encodeURIComponent(x.rel_file || '');
        const encPrev = encodeURIComponent(x.rel_image || '');
        const btnDel = `<button class="btn btn-sm btn-outline-danger ms-2"
                   onclick="deleteMigx(${Number(x.resource_id) || 0}, '${encFile}', '${encPrev}')">
                   Удалить из карточки</button>`;
        const meta = [
          x.pagetitle ? x.pagetitle : '',
          x.article ? `арт. ${x.article}` : '',
          x.vendor_name ? x.vendor_name : ''
        ].filter(Boolean).join(' • ');
        return `<li>
      <div><strong>${meta || ('ресурс #' + (x.resource_id || ''))}</strong></div>
      <div>
        <a href="${x.file}" target="_blank">${x.name || x.file}</a>
        ${x.preview ? ` — <img src="${x.preview}" style="height:40px;vertical-align:middle">` : ''}
        ${btnDel}
      </div>
    </li>`;
      }).join('');

      wrap.innerHTML = `<h5>Результаты</h5>
    <ul>${regHtml || '<li>В реестре нет записей</li>'}</ul>
    <ul>${migHtml || '<li>В MIGX ничего не найдено</li>'}</ul>`;
    }


    // обработчик кнопки «Найти документы»
    document.getElementById('btnSearch').addEventListener('click', () => doSearch());

    // удалить запись из реестра (без удаления файлов)
    async function deleteRegistry(id) {
      if (!id) return;
      if (!confirm('Удалить запись из реестра? Файлы на диске останутся.')) return;
      const fd = new FormData();
      fd.append('action', 'delete_registry');
      fd.append('id', String(id));
      fd.append('delete_files', '0'); // гарантированно не удаляем файлы
      const res = await fetch(connectorUrl, { method: 'POST', body: fd, credentials: 'same-origin' });
      const j = await res.json();
      updateTechPanel('delete_registry', j, j.diagnostics || []);

      if (!j.success) {
        alert(j.message || 'Ошибка удаления из реестра');
        console.error('delete_registry', j);
        return;
      }
      await doSearch();
    }

    // удалить элемент из MIGX у товара (файлы НЕ трогаем)
    async function deleteMigx(rid, encFile = '', encPrev = '') {
      if (!rid) return;
      if (!confirm('Удалить документ из этой карточки? Файлы на диске останутся.')) return;
      const fd = new FormData();
      fd.append('action', 'delete_migx_item');
      fd.append('resource_id', String(rid));
      if (encFile) fd.append('file', decodeURIComponent(encFile));
      if (encPrev) fd.append('image', decodeURIComponent(encPrev));
      const res = await fetch(connectorUrl, { method: 'POST', body: fd, credentials: 'same-origin' });
      const j = await res.json();
      updateTechPanel('delete_migx_item', j, j.diagnostics || []);

      if (!j.success) {
        alert(j.message || 'Ошибка удаления из карточки');
        console.error('delete_migx_item', j);
        return;
      }
      await doSearch();
    }

    // init
    (async function init() {
      try {
        await loadVendors();
        await loadFolders();
      } catch (e) {
        alert('Ошибка инициализации. Подробности в консоли.');
        console.error(e);
      }
    })();

    // сброс ID товара
    (function bindResourceIdReset() {
      const inpArticle = document.getElementById('inpArticle');
      const selVendor = document.getElementById('selVendor');
      const ridInput = document.getElementById('ridInput');

      if (!ridInput) return;

      const resetRid = () => {
        if (ridInput.value && ridInput.value.trim() !== '') {
          ridInput.value = '';
        }
      };

      if (inpArticle) {
        inpArticle.addEventListener('input', resetRid);
        inpArticle.addEventListener('change', resetRid);
      }

      if (selVendor) {
        selVendor.addEventListener('change', resetRid);
      }
    })();

    // удалить запись из реестра (из usage-блока), файлы НЕ трогаем
    async function usageDeleteRegistry(id, folder, name) {
      if (!id) return;
      if (!confirm('Удалить запись из реестра? Файлы на диске останутся.')) return;

      const fd = new FormData();
      fd.append('action', 'delete_registry');
      fd.append('id', String(id));
      fd.append('delete_files', '0');

      const res = await fetch(connectorUrl, { method: 'POST', body: fd, credentials: 'same-origin' });
      const j = await res.json();
      updateTechPanel('delete_registry (usage)', j, j.diagnostics || []);
      if (!j.success) {
        alert(j.message || 'Ошибка удаления из реестра');
        return;
      }
      // перерисовать usage по текущему файлу
      await loadFilesForFolder(folder);   // чтобы список файлов был актуальным
      document.getElementById('usageFolderSelect').value = folder;
      document.getElementById('usageFileSelect').value = name;
      await findFileUsage();
    }

    // удалить элемент MIGX у товара (из usage-блока), файлы НЕ трогаем
    async function usageDeleteMigx(resourceId, encRelFile, encFolder, encName) {
      if (!resourceId) return;
      const folder = decodeURIComponent(encFolder);
      const name = decodeURIComponent(encName);
      if (!confirm('Удалить документ из этой карточки? Файлы на диске останутся.')) return;

      const relFile = decodeURIComponent(encRelFile); // формат: "<folder>/<file.pdf>"

      const fd = new FormData();
      fd.append('action', 'delete_migx_item');
      fd.append('resource_id', String(resourceId));
      fd.append('file', relFile); // server сам приведёт к относительному
      // image (prev) не обязателен: удаляем по совпадению file

      const res = await fetch(connectorUrl, { method: 'POST', body: fd, credentials: 'same-origin' });
      const j = await res.json();
      updateTechPanel('delete_migx_item (usage)', j, j.diagnostics || []);
      if (!j.success) {
        alert(j.message || 'Ошибка удаления из карточки');
        return;
      }
      // перерисовать usage по текущему файлу
      await loadFilesForFolder(folder);
      document.getElementById('usageFolderSelect').value = folder;
      document.getElementById('usageFileSelect').value = name;
      await findFileUsage();
    }

    function getSelectedResourceIds() {
      const ids = [];
      document.querySelectorAll('#usageMigxList .usage-migx-check:checked').forEach(ch => {
        const id = Number(ch.getAttribute('data-resource-id') || '0');
        if (id) ids.push(id);
      });
      return Array.from(new Set(ids));
    }

    async function bulkDeleteSelectedMigx(folder, name) {
      const ids = getSelectedResourceIds();
      if (!ids.length) { alert('Не выбрано ни одной карточки'); return; }
      if (!confirm(`Удалить файл ${folder}/${name} из ${ids.length} выбранных карточек? Файлы на диске останутся.`)) return;

      const fd = new FormData();
      fd.append('action', 'bulk_delete_migx_by_file');
      fd.append('folder', folder);
      fd.append('name', name);
      fd.append('tv_name', 'sertif');
      fd.append('resource_ids', JSON.stringify(ids));

      const r = await fetch(connectorUrl, { method: 'POST', body: fd, credentials: 'same-origin' });
      const j = await r.json();
      updateTechPanel('bulk_delete_migx_by_file (selected)', j, j.diagnostics || []);
      if (!j.success) { alert(j.message || 'Ошибка'); return; }

      await loadFilesForFolder(folder);
      document.getElementById('usageFolderSelect').value = folder;
      document.getElementById('usageFileSelect').value = name;
      await findFileUsage();
    }

    async function bulkDeleteAllMigx(folder, name) {
      if (!confirm(`Удалить файл ${folder}/${name} из ВСЕХ карточек товаров? Файлы на диске останутся.`)) return;

      const fd = new FormData();
      fd.append('action', 'bulk_delete_migx_by_file');
      fd.append('folder', folder);
      fd.append('name', name);
      fd.append('tv_name', 'sertif');
      fd.append('all', '1');

      const r = await fetch(connectorUrl, { method: 'POST', body: fd, credentials: 'same-origin' });
      const j = await r.json();
      updateTechPanel('bulk_delete_migx_by_file (all)', j, j.diagnostics || []);
      if (!j.success) { alert(j.message || 'Ошибка'); return; }

      await loadFilesForFolder(folder);
      document.getElementById('usageFolderSelect').value = folder;
      document.getElementById('usageFileSelect').value = name;
      await findFileUsage();
    }

    async function bulkCleanRegistry(folder, name) {
      if (!confirm(`Очистить реестр для файла ${folder}/${name}? Файлы на диске останутся.`)) return;

      const fd = new FormData();
      fd.append('action', 'bulk_delete_registry_by_file');
      fd.append('folder', folder);
      fd.append('name', name);

      const r = await fetch(connectorUrl, { method: 'POST', body: fd, credentials: 'same-origin' });
      const j = await r.json();
      updateTechPanel('bulk_delete_registry_by_file', j, j.diagnostics || []);
      if (!j.success) { alert(j.message || 'Ошибка'); return; }

      await findFileUsage(); // перечитать использование
    }


    // наполним селект папок для режима «поиск по файлу» тем же списком, что и основной
    async function populateUsageFolders() {
      const selMain = document.getElementById('folderSelect');
      const selUsage = document.getElementById('usageFolderSelect');
      if (!selMain || !selUsage) return;
      selUsage.innerHTML = '<option value="">(выбрать)</option>';
      [...selMain.options].forEach(o => {
        if (!o.value) return;
        const opt = document.createElement('option');
        opt.value = o.value;
        opt.textContent = o.textContent;
        selUsage.appendChild(opt);
      });
    }

    // загрузка списка PDF в папке
    async function loadFilesForFolder(folder) {
      const fileSel = document.getElementById('usageFileSelect');
      const btn = document.getElementById('btnUsageSearch');
      fileSel.innerHTML = '<option value="">(загрузка...)</option>';
      fileSel.disabled = true; btn.disabled = true;
      if (!folder) {
        fileSel.innerHTML = '<option value="">(сначала выберите папку)</option>';
        return;
      }
      const q = new URLSearchParams({ action: 'list_files', folder });
      const r = await fetch(connectorUrl + '?' + q.toString(), { credentials: 'same-origin' });
      const txt = await r.text(); let j;
      try { j = JSON.parse(txt); } catch (e) { updateTechPanel('list_files (parse error)', txt, []); throw e; }
      updateTechPanel('list_files', j, j.diagnostics || []);
      fileSel.innerHTML = '';
      (j.files || []).forEach(f => {
        const opt = document.createElement('option');
        opt.value = f.name;
        opt.textContent = f.name;
        fileSel.appendChild(opt);
      });
      if (!fileSel.options.length) {
        fileSel.innerHTML = '<option value="">(в папке нет PDF)</option>';
        fileSel.disabled = true; btn.disabled = true;
      } else {
        fileSel.disabled = false; btn.disabled = false;
      }
    }

    // поиск использования выбранного файла
    async function findFileUsage() {
      const folder = document.getElementById('usageFolderSelect').value;
      const name = document.getElementById('usageFileSelect').value;
      if (!folder || !name) { alert('Выберите папку и файл'); return; }
      const q = new URLSearchParams({ action: 'file_usage', folder, name, tv_name: 'sertif' });
      const r = await fetch(connectorUrl + '?' + q.toString(), { credentials: 'same-origin' });
      const txt = await r.text(); let j;
      try { j = JSON.parse(txt); } catch (e) { updateTechPanel('file_usage (parse error)', txt, []); throw e; }
      updateTechPanel('file_usage', j, j.diagnostics || []);

      const box = document.getElementById('usageResults');

      const reg = (j.registry || []).map(x => `
        <li class="mb-1">
          Реестр: <a href="${x.pdf_url}" target="_blank">${x.pdf_name}</a>
          ${x.thumb_url ? `— <img src="${x.thumb_url}" style="height:40px;vertical-align:middle">` : ''}
          <small class="text-muted">[${x.vendor_name || ''}]</small>
          <button class="btn btn-sm btn-outline-danger ms-2"
                  onclick="usageDeleteRegistry(${Number(x.id) || 0}, '${folder}', '${name}')">
            Удалить из реестра
          </button>
        </li>
      `).join('');

      const mig = (j.migx || []).map(x => `
        <li class="mb-1">
          <input type="checkbox" class="form-check-input me-2 usage-migx-check"
                data-resource-id="${Number(x.resource_id) || 0}">
          ${(() => {
          const meta = [
            x.pagetitle ? x.pagetitle : '',
            x.article ? `арт. ${x.article}` : '',
            x.vendor_name ? x.vendor_name : ''
          ].filter(Boolean).join(' • ');
          return meta ? meta : ('Ресурс #' + (x.resource_id || ''));
        })()}:
          <a href="${x.file_url}" target="_blank">${x.name || x.rel_file}</a>
          ${x.preview_url ? `— <img src="${x.preview_url}" style="height:40px;vertical-align:middle">` : ''}
          <button class="btn btn-sm btn-outline-danger ms-2"
                  onclick="usageDeleteMigx(${Number(x.resource_id) || 0}, '${encodeURIComponent(x.rel_file || '')}', '${encodeURIComponent(folder)}', '${encodeURIComponent(name)}')">
            Удалить из карточки
          </button>
        </li>
      `).join('');


      box.innerHTML = `
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div>Использование файла: ${folder}/${name}</div>
            <div class="d-flex align-items-center gap-2">
              <div class="form-check me-2">
                <input class="form-check-input" type="checkbox" id="usageSelectAll" />
                <label class="form-check-label" for="usageSelectAll">Выбрать все</label>
              </div>
              <button class="btn btn-sm btn-danger" id="btnBulkDeleteSelected">Удалить выбранные из карточек</button>
              <button class="btn btn-sm btn-outline-danger" id="btnBulkDeleteAll">Удалить все из карточек</button>
              <button class="btn btn-sm btn-outline-secondary" id="btnBulkCleanRegistry">Очистить реестр</button>
            </div>
          </div>
          <div class="card-body">
            <div class="mb-2"><strong>В реестре:</strong></div>
            <ul>${reg || '<li>совпадений нет</li>'}</ul>
            <div class="mb-2 mt-3"><strong>В карточках товаров (MIGX):</strong></div>
            <ul id="usageMigxList">${mig || '<li>совпадений нет</li>'}</ul>
          </div>
        </div>
      `;

      // навесим обработчики кнопок
      const selAll = document.getElementById('usageSelectAll');
      if (selAll) {
        selAll.addEventListener('change', (e) => {
          document.querySelectorAll('#usageMigxList .usage-migx-check').forEach(ch => ch.checked = e.target.checked);
        });
      }
      const btnSel = document.getElementById('btnBulkDeleteSelected');
      if (btnSel) {
        btnSel.addEventListener('click', () => bulkDeleteSelectedMigx(folder, name));
      }
      const btnAll = document.getElementById('btnBulkDeleteAll');
      if (btnAll) {
        btnAll.addEventListener('click', () => bulkDeleteAllMigx(folder, name));
      }
      const btnReg = document.getElementById('btnBulkCleanRegistry');
      if (btnReg) {
        btnReg.addEventListener('click', () => bulkCleanRegistry(folder, name));
      }


    }

    // события
    document.getElementById('usageFolderSelect').addEventListener('change', (e) => loadFilesForFolder(e.target.value));
    document.getElementById('btnUsageSearch').addEventListener('click', () => findFileUsage());

  </script>

</body>

</html>