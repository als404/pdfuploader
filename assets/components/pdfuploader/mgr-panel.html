<!doctype html>
<html lang="ru">

<head>
  <meta charset="utf-8">
  <title>pdfuploader</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font: 14px/1.4 Arial, sans-serif;
      margin: 16px;
    }

    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: flex-end;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 4px;
    }

    input,
    select,
    button {
      font: 14px Arial;
      padding: 6px 8px;
    }

    button {
      cursor: pointer;
    }

    .box {
      border: 1px solid #ddd;
      padding: 12px;
      border-radius: 6px;
      margin-top: 12px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .muted {
      color: #777;
    }

    .small {
      font-size: 12px;
    }

    pre {
      background: #f7f7f7;
      border: 1px solid #eee;
      padding: 10px;
      overflow: auto;
    }

    .doc {
      display: flex;
      gap: 10px;
      align-items: center;
      margin: 8px 0;
    }

    .doc img {
      width: 54px;
      height: 54px;
      object-fit: cover;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .doc a {
      word-break: break-all;
    }

    .doc .meta {
      font-size: 12px;
      color: #666;
    }
  </style>
</head>

<body>

  <h2>pdfuploader - панель</h2>

  <div class="box">
    <div class="row">
      <div>
        <label>TV name</label>
        <input id="tv_name" value="sertif">
      </div>
      <div>
        <label>Бренд</label>
        <select id="vendor_id">
          <option value="0">Все</option>
        </select>
      </div>
      <div>
        <label>Артикул</label>
        <input id="article" placeholder="например 2020016">
      </div>
      <div>
        <label>ID товара</label>
        <input id="resource_id" placeholder="например 8131">
      </div>
      <div>
        <button id="btn_search">Найти документы</button>
      </div>
    </div>

    <hr>

    <div class="row">
      <div>
        <label>file_usage - folder</label>
        <input id="u_folder" placeholder="instructions">
      </div>
      <div>
        <label>name</label>
        <input id="u_name" placeholder="2020016.pdf">
      </div>
      <div>
        <button id="btn_usage">Проверить</button>
      </div>
      <div>
        <button id="btn_ping">ping</button>
      </div>
      <div class="muted small" id="status"></div>
    </div>
  </div>

  <div class="grid">
    <div class="box">
      <h3>В реестре</h3>
      <div id="registry_block" class="muted">совпадений нет</div>
    </div>
    <div class="box">
      <h3>В карточках товаров (MIGX)</h3>
      <div id="migx_block" class="muted">совпадений нет</div>
    </div>
  </div>

  <div class="box">
    <h3>file_usage</h3>
    <div class="grid">
      <div>
        <div class="small muted">В реестре:</div>
        <div id="usage_registry" class="muted">совпадений нет</div>
      </div>
      <div>
        <div class="small muted">В карточках товаров (MIGX):</div>
        <div id="usage_migx" class="muted">совпадений нет</div>
      </div>
    </div>
  </div>

  <div class="box">
    <h3>Технические детали</h3>
    <div class="small muted" id="tech_time"></div>
    <pre id="tech"></pre>
  </div>

  <script>
    const CONNECTOR = 'connector.php';
    const $ = (id) => document.getElementById(id);

    function nowStr() {
      const d = new Date();
      const pad = (n) => String(n).padStart(2, '0');
      return `${pad(d.getDate())}.${pad(d.getMonth() + 1)}.${d.getFullYear()}, ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }
    function setTech(obj) {
      $('tech_time').textContent = nowStr();
      $('tech').textContent = JSON.stringify(obj, null, 2);
    }
    async function api(params) {
      const q = new URLSearchParams(params);
      const r = await fetch(CONNECTOR + '?' + q.toString(), { credentials: 'same-origin' });
      const j = await r.json();
      setTech(j);
      return j;
    }
    function renderDocs(container, arr) {
      if (!arr || !arr.length) {
        container.innerHTML = '<span class="muted">совпадений нет</span>';
        return;
      }
      container.innerHTML = '';
      arr.forEach((it) => {
        const div = document.createElement('div');
        div.className = 'doc';

        const img = document.createElement('img');
        img.alt = '';
        img.src = it.thumb_url || '';
        if (!img.src) img.style.display = 'none';

        const body = document.createElement('div');
        const a = document.createElement('a');
        a.href = it.pdf_url || '';
        a.target = '_blank';
        a.textContent = it.file || it.pdf_name || it.name || it.pdf_url || 'document';

        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.textContent = [
          it.article ? `арт ${it.article}` : '',
          it.vendor_name ? `бренд ${it.vendor_name}` : '',
          it.folder ? `папка ${it.folder}` : '',
          it.resource_id ? `ID ${it.resource_id}` : ''
        ].filter(Boolean).join(' - ');

        body.appendChild(a);
        if (meta.textContent) body.appendChild(meta);

        div.appendChild(img);
        div.appendChild(body);
        container.appendChild(div);
      });
    }

    async function loadVendors() {
      const j = await api({ action: 'list_vendors' });
      const sel = $('vendor_id');
      if (!j.success) return;
      (j.items || []).forEach(v => {
        const o = document.createElement('option');
        o.value = v.id;
        o.textContent = v.name;
        sel.appendChild(o);
      });
    }

    $('btn_ping').addEventListener('click', async () => {
      $('status').textContent = '...';
      const j = await api({ action: 'ping' });
      $('status').textContent = j.success ? 'OK' : ('ERR: ' + (j.message || ''));
    });

    $('btn_search').addEventListener('click', async () => {
      $('registry_block').innerHTML = '<span class="muted">загрузка...</span>';
      $('migx_block').innerHTML = '<span class="muted">загрузка...</span>';

      const tv_name = $('tv_name').value.trim() || 'sertif';
      const vendor_id = $('vendor_id').value || '0';
      const article = $('article').value.trim();
      const resource_id = $('resource_id').value.trim();

      const j = await api({ action: 'search_all', tv_name, vendor_id, article, resource_id });

      renderDocs($('registry_block'), j.from_registry || []);
      renderDocs($('migx_block'), j.from_migx || []);
    });

    $('btn_usage').addEventListener('click', async () => {
      $('usage_registry').innerHTML = '<span class="muted">загрузка...</span>';
      $('usage_migx').innerHTML = '<span class="muted">загрузка...</span>';

      const tv_name = $('tv_name').value.trim() || 'sertif';
      const folder = $('u_folder').value.trim();
      const name = $('u_name').value.trim();

      const j = await api({ action: 'file_usage', tv_name, folder, name });

      renderDocs($('usage_registry'), j.registry || []);
      renderDocs($('usage_migx'), j.migx || []);
    });

    loadVendors();
  </script>

</body>

</html>